<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enterprise Library Data Access Application Block: Data Access Application Block User Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="entlib_new_icon_100x100.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Enterprise Library Data Access Application Block
   &#160;<span id="projectnumber">7.0-rc1</span>
   </div>
   <div id="projectbrief">The Data Access Application Block abstracts the actual database you are using, and exposes a collection of methods that make it easy to access that database and to perform common tasks.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('a00949.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Data Access Application Block User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md0">What is the Data Access Application Block</a></li>
<li class="level2"><a href="#autotoc_md1">NuGet Packages</a></li>
<li class="level2"><a href="#Configuration">Configuration</a><ul><li class="level3"><a href="#autotoc_md2">Oracle Configuration</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md3">Code Examples</a><ul><li class="level3"><a href="#autotoc_md4">Creating Database Instances</a></li>
<li class="level3"><a href="#autotoc_md5">Reading Rows Using a Query with No Parameters</a></li>
<li class="level3"><a href="#autotoc_md6">Reading Rows Using a Query with unnamed Parameters</a></li>
<li class="level3"><a href="#autotoc_md7">Reading Rows Using a Query with named Parameters</a></li>
<li class="level3"><a href="#autotoc_md8">Retrieving Data as Objects</a></li>
<li class="level3"><a href="#autotoc_md9">Creating and Using Mappers</a></li>
<li class="level3"><a href="#autotoc_md10">Retrieving XML Data</a></li>
<li class="level3"><a href="#autotoc_md11">Retrieving Single Scalar Values</a></li>
<li class="level3"><a href="#autotoc_md12">Retrieving Data Asynchronously</a></li>
<li class="level3"><a href="#autotoc_md13">Updating Data</a></li>
<li class="level3"><a href="#autotoc_md14">Working with DataSets</a><ul><li class="level4"><a href="#autotoc_md15">Retrieving data as DataSet</a></li>
<li class="level4"><a href="#autotoc_md16">Updating the Database from a DataSet</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_Pages_Overview"></a></p>
<p>This guide shows how to use the Enterprise Library Data Access Application Block (DAAB for short) version 7.0. For a guide to version 6.0, see the <a href="https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn440726(v=pandp.60)">original documentation by Microsoft</a>.</p>
<h2><a class="anchor" id="autotoc_md0"></a>
What is the Data Access Application Block</h2>
<p>The Data Access Application Block abstracts the actual database you are using, and exposes a collection of methods that make it easy to access that database and to perform common tasks. The block is designed to simplify the task of calling stored procedures, but it also provides full support for the use of parameterized SQL statements.</p>
<p>In other words, the Data Access Application Block provides access to the most often used features of ADO.NET in simple-to-use classes and provides a corresponding boost to developer productivity.</p>
<p>In addition to the more common approaches familiar to users of ADO.NET, the Data Access block also exposes techniques for asynchronous data access for databases that support this feature using the Asynchronous Programming Model (TPL coming in the near future), and provides the ability to return data as a sequence of objects suitable for client-side querying using techniques such as Language Integrated Query (LINQ).</p>
<p>However, the block is not intended to be an Object/Relational Mapping (O/RM) solution. Although it uses mappings to relate parameters and relational data with the properties of objects, but does not implement an O/RM modeling solution.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
NuGet Packages</h2>
<p>DAAB is composed of a base package, called <a href="https://www.nuget.org/packages/EnterpriseLibrary.Data.NetCore/">EnterpriseLibrary.Data.NetCore</a>, and several other packages which support specific database engines. For databases which are not directly supported by DAAB, only the base package is needed. The database-specific packages support unique features of those systems.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Supported Database   </th><th class="markdownTableHeadNone">Package   </th><th class="markdownTableHeadNone">.NET Framework support    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Generic   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7; .NET Core 2.1, 3.1; .NET Standard 2.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">OLE DB   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.OleDb.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7; .NET Core 2.1, 3.1; .NET Standard 2.0    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SQL Server   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.SqlServer.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7; .NET Core 2.1, 3.1; .NET Standard 2.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Oracle   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.Oracle.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7; .NET Core 2.1, 3.1; .NET Standard 2.0    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ODBC   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.Odbc.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7; .NET Core 2.1, 3.1; .NET Standard 2.0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SQL Server CE   </td><td class="markdownTableBodyNone">EnterpriseLibrary.Data.SqlCe.NetCore   </td><td class="markdownTableBodyNone">.NET 4.5.2, 4.6, 4.7   </td></tr>
</table>
<h2><a class="anchor" id="Configuration"></a>
Configuration</h2>
<p>After installing the appropriate package(s), you should add the following configuration elements to your app.config or web.config file.</p><ol type="1">
<li>Under the <code>&lt;configSections&gt;</code> element, add the following section: <div class="fragment"><div class="line">&lt;<span class="keywordtype">section</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;dataConfiguration&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;Microsoft.Practices.EnterpriseLibrary.Data.Configuration.DatabaseSettings, Microsoft.Practices.EnterpriseLibrary.Data&quot;</span> /&gt;</div>
</div><!-- fragment --></li>
<li>Under the <code>&lt;connectionStrings&gt;</code> section, add a normal connection string to your database, with a <code>name</code>, <code>connectionString</code> and <code>providerName</code> attributes. DAAB supports the following provider names:<ol type="a">
<li><code>System.Data.SqlClient</code> (.NET built-in provider for SQL Server)</li>
<li><code>Oracle.ManagedDataAccess.Client</code> (Managed ADO.NET provider by Oracle, known as ODP.NET)</li>
<li><code>System.Data.OleDb</code></li>
<li><code>System.Data.Odbc</code></li>
<li><code>System.Data.SqlServerCe.4.0</code> (Latest provider for SQL Server CE, available as a NuGet package)</li>
</ol>
</li>
<li>Under the root <code>&lt;configuration&gt;</code> element, but somewhere bellow the <code>&lt;configSections&gt;</code>, add the following section: <div class="fragment"><div class="line">&lt;<span class="keywordtype">dataConfiguration</span> <span class="keyword">defaultDatabase</span>=<span class="stringliteral">&quot;MyConnectionString&quot;</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">dataConfiguration</span>&gt;</div>
</div><!-- fragment --> The <code>defaultDatabase</code> attribute points to the <code>name</code> of the connection string above. In code, you can direct DAAB to use a different connection string.</li>
<li>Under the <code>&lt;dataConfiguration&gt;</code> add the following section: <div class="fragment"><div class="line">&lt;<span class="keywordtype">providerMappings</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">add</span> <span class="keyword">databaseType</span>=<span class="stringliteral">&quot;&quot;</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;&quot;</span> /&gt;</div>
<div class="line">&lt;/<span class="keywordtype">providerMappings</span>&gt;</div>
</div><!-- fragment --><ol type="a">
<li><code>name</code> is a provider name, as listed above in section 2.</li>
<li><code>databaseType</code> is one of the following types:</li>
</ol>
</li>
</ol>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Database   </th><th class="markdownTableHeadNone">databaseType    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Generic   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.GenericDatabase, Microsoft.Practices.EnterpriseLibrary.Data"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SQL Server CE   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.SqlCe.SqlCeDatabase, Microsoft.Practices.EnterpriseLibrary.Data.SqlCe"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Oracle   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.Oracle.OracleDatabase, Microsoft.Practices.EnterpriseLibrary.Data.Oracle"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SQL Server   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.Sql.SqlDatabase, Microsoft.Practices.EnterpriseLibrary.Data.SqlServer"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">OLE DB   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.OleDb.OleDbDatabase, Microsoft.Practices.EnterpriseLibrary.Data.OleDb"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ODBC   </td><td class="markdownTableBodyNone">"Microsoft.Practices.EnterpriseLibrary.Data.Odbc.OdbcDatabase, Microsoft.Practices.EnterpriseLibrary.Data.Odbc"   </td></tr>
</table>
<p>You can add multiple mappings if you access more than one database type.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
Oracle Configuration</h3>
<p>For Oracle databases, we also need to configure packages.</p><ol type="1">
<li>Under <code>&lt;configSections&gt;</code>, in addition to the <code>dataConfiguration</code> section, add <div class="fragment"><div class="line">&lt;<span class="keywordtype">section</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;oracleConnectionSettings&quot;</span> <span class="keyword">type</span>=<span class="stringliteral">&quot;Microsoft.Practices.EnterpriseLibrary.Data.Oracle.Configuration.OracleConnectionSettings, Microsoft.Practices.EnterpriseLibrary.Data.Oracle&quot;</span> /&gt;</div>
</div><!-- fragment --></li>
<li>Under the root <code>&lt;configuration&gt;</code> element, but somewhere bellow the <code>&lt;configSections&gt;</code>, add the following section: <div class="fragment"><div class="line">&lt;<span class="keywordtype">oracleConnectionSettings</span>&gt;</div>
<div class="line">  &lt;<span class="keywordtype">add</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;OracleTest&quot;</span>&gt;</div>
<div class="line">    &lt;<span class="keywordtype">packages</span>&gt;</div>
<div class="line">      &lt;<span class="keywordtype">add</span> <span class="keyword">name</span>=<span class="stringliteral">&quot;ENTLIBTEST&quot;</span> <span class="keyword">prefix</span>=<span class="stringliteral">&quot;GetProductDetailsById&quot;</span> /&gt;</div>
<div class="line">    &lt;/<span class="keywordtype">packages</span>&gt;</div>
<div class="line">  &lt;/<span class="keywordtype">add</span>&gt;</div>
<div class="line">&lt;/<span class="keywordtype">oracleConnectionSettings</span>&gt;</div>
</div><!-- fragment --><ol type="a">
<li>The <code>name</code> attribute in the <code>&lt;add&gt;</code> element points to the name of a connection string from section 2 above.</li>
<li>in each package, the <code>name</code> in the <code>&lt;add&gt;</code> element is a package name, which will be prefixed to the stored procedure specified in the <code>prefix</code> attribute.</li>
</ol>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md3"></a>
Code Examples</h2>
<h3><a class="anchor" id="autotoc_md4"></a>
Creating Database Instances</h3>
<p>The simplest approach for creating a <code>Database</code> object or one of its descendants is calling the <code>CreateDefault</code> or <code>Create</code> method of the <code>DatabaseProviderFactory</code> class, as shown here, and storing these instances in application-wide variables so that they can be accessed from anywhere in the code. </p><div class="fragment"><div class="line"><span class="comment">// Configure the DatabaseFactory to read its configuration from the .config file</span></div>
<div class="line">DatabaseProviderFactory factory = <span class="keyword">new</span> DatabaseProviderFactory();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the default Database object from the factory.</span></div>
<div class="line"><span class="comment">// The actual concrete type is determined by the configuration settings.</span></div>
<div class="line">Database defaultDB = factory.CreateDefault();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a Database object from the factory using the connection string name.</span></div>
<div class="line">Database namedDB = factory.Create(<span class="stringliteral">&quot;ExampleDatabase&quot;</span>);</div>
</div><!-- fragment --><p> where "ExampleDatabase" is a <code>name</code> of a connection string. With <code>CreateDefault</code>, the connection string specified by the <code>defaultDatabase</code> attribute of the <code>dataConfiguration</code> element in web.config is used, as described above. Using the default database is a useful approach because you can change which of the databases defined in your configuration is the default simply by editing the configuration file, without requiring recompilation or redeployment of the application.</p>
<p>Some features are only available in the concrete types for a specific database. For example, the <code>ExecuteXmlReader</code> method is only available in the <code>SqlDatabase</code> class. If you want to use such features, you must cast the database type you instantiate to the appropriate concrete type.</p>
<p>As alternative to using the <code>DatabaseProviderFactory</code> class, you could use the static <code>DatabaseFactory</code> façade to create your <code>Database</code> instances. You must invoke the <code>SetDatabaseProviderFactory</code> method to set the details of the default database from the configuration file.</p>
<div class="fragment"><div class="line">DatabaseFactory.SetDatabaseProviderFactory(factory, <span class="keyword">false</span>);</div>
<div class="line">defaultDB = DatabaseFactory.CreateDatabase(<span class="stringliteral">&quot;ExampleDatabase&quot;</span>);</div>
<div class="line"><span class="comment">// Uses the default database from the configuration file.</span></div>
<div class="line">sqlServerDB = DatabaseFactory.CreateDatabase() as SqlDatabase;</div>
</div><!-- fragment --><p>In addition to using configuration to define the databases you will use, the Data Access block allows you to create instances of concrete types that inherit from the Database class directly in your code, as shown here.</p>
<div class="fragment"><div class="line">SqlDatabase sqlDatabase = <span class="keyword">new</span> SqlDatabase(myConnectionString);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md5"></a>
Reading Rows Using a Query with No Parameters</h3>
<p>To read rows using a stored procedure with no parameters, retrieve an <code>IDataReader</code> and read values from it: </p><div class="fragment"><div class="line"><span class="comment">// Call the ExecuteReader method by specifying just the stored procedure name.</span></div>
<div class="line"><span class="keyword">using</span> (IDataReader reader = namedDB.ExecuteReader(<span class="stringliteral">&quot;MyStoredProcName&quot;</span>))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Use the values in the rows as required.</span></div>
<div class="line">    DisplayRowValues(reader);</div>
<div class="line">}</div>
</div><!-- fragment --><p> <code>ExecuteReader</code> also accept a <code>CommandType</code>, but the default value is <code>CommandType.StoredProcedure</code>.</p>
<p>To use an inline SQL statement, specify a <code>CommandType.Text</code>: </p><div class="fragment"><div class="line"><span class="comment">// Call the ExecuteReader method by specifying the command type</span></div>
<div class="line"><span class="comment">// as a SQL statement, and passing in the SQL statement.</span></div>
<div class="line"><span class="keyword">using</span> (IDataReader reader = namedDB.ExecuteReader(CommandType.Text, <span class="stringliteral">&quot;SELECT TOP 1 * FROM OrderList&quot;</span>))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Use the values in the rows as required - here we are just displaying them.</span></div>
<div class="line">    DisplayRowValues(reader);</div>
<div class="line">}</div>
</div><!-- fragment --><p>You read the values from the <code>IDataReader</code> normally: </p><div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keywordtype">void</span> DisplayRowValues(IDataReader reader)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">while</span> (reader.Read())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; reader.FieldCount; i++)</div>
<div class="line">        {</div>
<div class="line">            Console.WriteLine(<span class="stringliteral">&quot;{0} = {1}&quot;</span>, reader.GetName(i), reader[i].ToString());</div>
<div class="line">        }</div>
<div class="line">        Console.WriteLine();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md6"></a>
Reading Rows Using a Query with unnamed Parameters</h3>
<p>If you use only input parameters, you can pass their values to the stored procedure or SQL statement directly and let the <code>Database</code> class wrap them in the appropriate <code>DbParameter</code> objects. You must pass them in the same order as they are expected by the query, because you are not using names for these parameters. The following code executes a stored procedure that takes a single string parameter. </p><div class="fragment"><div class="line"><span class="comment">// Call the ExecuteReader method with the stored procedure</span></div>
<div class="line"><span class="comment">// name and an Object array containing the parameter values.</span></div>
<div class="line"><span class="keyword">using</span> (IDataReader reader = defaultDB.ExecuteReader(<span class="stringliteral">&quot;ListOrdersByState&quot;</span>, <span class="stringliteral">&quot;Colorado&quot;</span>))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Use the values in the rows as required - here we are just displaying them.</span></div>
<div class="line">    DisplayRowValues(reader);</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Reading Rows Using a Query with named Parameters</h3>
<p>If you need to specify the data-types of the parameters, e.g. if it can't be inferred from the .NET data type, or you need to specify the parameter direction (input or output), you can access the provider independent <code>DbCommand</code> object for the query and add parameters using methods on the <code>Database</code> object. You can add parameters with a specific direction using the <code>AddInParameter</code> or <code>AddOutParameter</code> method, or by using the <code>AddParameter</code> method and providing a value for the <code>ParameterDirection</code> parameter. You can change the value of existing parameters already added to the command using the <code>GetParameterValue</code> and <code>SetParameterValue</code> methods. </p><div class="fragment"><div class="line"><span class="comment">// Read data with a SQL statement that accepts one parameter prefixed with @.</span></div>
<div class="line"><span class="keywordtype">string</span> sqlStatement = <span class="stringliteral">&quot;SELECT TOP 1 * FROM OrderList WHERE State LIKE @state&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a suitable command type and add the required parameter.</span></div>
<div class="line"><span class="keyword">using</span> (DbCommand sqlCmd = defaultDB.GetSqlStringCommand(sqlStatement))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Any required prefix, such as &#39;@&#39; or &#39;:&#39; will be added automatically if missing.</span></div>
<div class="line">    defaultDB.AddInParameter(sqlCmd, <span class="stringliteral">&quot;state&quot;</span>, DbType.String, <span class="stringliteral">&quot;New York&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Call the ExecuteReader method with the command.</span></div>
<div class="line">    <span class="keyword">using</span> (IDataReader sqlReader = defaultDB.ExecuteReader(sqlCmd))</div>
<div class="line">    {</div>
<div class="line">        DisplayRowValues(sqlReader);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Now read the same data with a stored procedure that accepts one parameter.</span></div>
<div class="line"><span class="keywordtype">string</span> storedProcName = <span class="stringliteral">&quot;ListOrdersByState&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a suitable command type and add the required parameter.</span></div>
<div class="line"><span class="keyword">using</span> (DbCommand sprocCmd = defaultDB.GetStoredProcCommand(storedProcName))</div>
<div class="line">{</div>
<div class="line">    defaultDB.AddInParameter(sprocCmd, <span class="stringliteral">&quot;state&quot;</span>, DbType.String, <span class="stringliteral">&quot;New York&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Call the ExecuteReader method with the command.</span></div>
<div class="line">    <span class="keyword">using</span> (IDataReader sprocReader = defaultDB.ExecuteReader(sprocCmd))</div>
<div class="line">    {</div>
<div class="line">        DisplayRowValues(sprocReader);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md8"></a>
Retrieving Data as Objects</h3>
<p>DAAB allows you to extract data using a query, and have the data returned to you as a sequence of objects that implements the <code>IEnumerable</code> interface. This allows you to execute queries, or obtain lists or arrays of objects that represent the original data in the database.</p>
<p>The block provides two core classes for performing this kind of query: the <code>SprocAccessor</code> and the <code>SqlStringAccessor</code>. You can create and execute these accessors in one operation using the <code>ExecuteSprocAccessor</code> and <code>ExecuteSqlAccessor</code> extension methods of the <code>Database</code> class, or create a new accessor directly and then call its <code>Execute</code> method.</p>
<p>If you do not specify an output mapper, the block uses a default map builder class that maps the column names of the returned data to properties of the objects it creates. Alternatively, you can create a custom mapping to specify the relationship between columns in the row set and the properties of the objects. Inferring the details required to create the correct mappings means that the default output mappers <b>can have an effect on performance</b>. You may prefer to create your own custom mappers and retain a reference to them for reuse when possible to maximize performance of your data access processes when using accessors.</p>
<p>The following code shows how you can use an accessor to execute a stored procedure. You must specify the object type that you want the data returned as—in this example it is a simple class named <code>Product</code> that has the three properties: <code>ID</code>, <code>Name</code>, and <code>Description</code>.</p>
<p>The stored procedure takes a single parameter that is a search string, and returns details of all products in the database that contain this string. Therefore, the code calls the <code>ExecuteSprocAccessor</code> extension method passing the search string as the single parameter. It specifies the <code>Product</code> class as the type of object to return, and passes to the method the name of the stored procedure to execute and the array of parameter values.</p>
<div class="fragment"><div class="line"><span class="comment">// Create and execute a sproc accessor that uses the default</span></div>
<div class="line"><span class="comment">// parameter and output mappings.</span></div>
<div class="line">var productData = defaultDB.ExecuteSprocAccessor&lt;Product&gt;(<span class="stringliteral">&quot;GetProductList&quot;</span>, <span class="stringliteral">&quot;%bike%&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Display the results</span></div>
<div class="line"><span class="keywordflow">foreach</span> (var item <span class="keywordflow">in</span> results)</div>
<div class="line">{</div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;Product ID: {0}&quot;</span>, item.ID);</div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;Product Name: {0}&quot;</span>, item.Name);</div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;Description: {0}&quot;</span>, item.Description);</div>
<div class="line">    Console.WriteLine();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md9"></a>
Creating and Using Mappers</h3>
<p>In some cases, you may need to create a custom parameter mapper to pass your parameters to the query that the accessor will execute. This typically occurs when you need to execute a SQL statement to work with a database system that does not support parameter resolution, or when a default mapping cannot be inferred due to a mismatch in the number or types of the parameters. The parameter mapper class must implement the <code>IParameterMapper</code> interface and contain a method named <code>AssignParameters</code> that takes a reference to the current <code>DbCommand</code> instance and the array of parameters. The method simply needs to add the required parameters to the <code>DbCommand</code> object's <code>Parameters</code> collection.</p>
<p>More often, you will need to create a custom output mapper. To help you do this, the block provides a class called <code>MapBuilder</code> that you can use to create the set of mappings you require between the columns of the data set returned by the query and the properties of the objects you need.</p>
<p>By default, the accessor will expect to generate a simple sequence of a single type of object (in our earlier example, this was a sequence of the <code>Product</code> class). However, you can use an accessor to return a more complex graph of objects if you wish. For example, you might execute a query that returns a series of <code>Order</code> objects and the related <code>OrderLines</code> objects for all of the selected orders. Simple output mapping cannot cope with this scenario, and neither can the <code>MapBuilder</code> class. In this case, you would create a result set mapper by implementing the <code>IResultSetMapper</code> interface. Your custom row set mapper must contain a method named <code>MapSet</code> that receives a reference to an object that implements the <code>IDataReader</code> interface. The method should read all of the data available through the data reader, processes it to create the sequence of objects you require, and return this sequence.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Retrieving XML Data</h3>
<p>SQL Server allows you to extract data as a series of XML elements, by executing specially formatted SQL queries. The Data Access block provides the <code>ExecuteXmlReader</code> method for querying data as XML. It takes a SQL statement that contains the <code>FOR XML</code> statement and executes it against the database, returning the result as an <code>XmlReader</code>. You can iterate through the resulting XML elements or work with them in any of the ways supported by the XML classes in the .NET Framework. However, as the implementations of this type of query differ in other database systems, it is only available when you specifically use the <code>SqlDatabase</code> class (rather than the <code>Database</code> class).</p>
<p>The following code shows how you can obtain a <code>SqlDatabase</code> instance, specify a suitable XML query, and execute it using the <code>ExecuteXmlReader</code> method.</p>
<div class="fragment"><div class="line"><span class="comment">// Create a SqlDatabase object from configuration using the default database.</span></div>
<div class="line">SqlDatabase sqlServerDB = DatabaseFactory.CreateDatabase() as SqlDatabase;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Specify a SQL query that returns XML data.</span></div>
<div class="line"><span class="keywordtype">string</span> xmlQuery = <span class="stringliteral">&quot;SELECT * FROM OrderList WHERE State = @state FOR XML AUTO&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a suitable command type and add the required parameter</span></div>
<div class="line"><span class="comment">// NB: ExecuteXmlReader is only available for SQL Server databases</span></div>
<div class="line"><span class="keyword">using</span> (DbCommand xmlCmd = sqlServerDB.GetSqlStringCommand(xmlQuery))</div>
<div class="line">{</div>
<div class="line">    xmlCmd.Parameters.Add(<span class="keyword">new</span> SqlParameter(<span class="stringliteral">&quot;state&quot;</span>, <span class="stringliteral">&quot;Colorado&quot;</span>));</div>
<div class="line">    <span class="keyword">using</span> (XmlReader reader = sqlServerDB.ExecuteXmlReader(xmlCmd))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Iterate through the elements in the XmlReader</span></div>
<div class="line">        <span class="keywordflow">while</span> (!reader.EOF)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (reader.IsStartElement())</div>
<div class="line">            {</div>
<div class="line">                Console.WriteLine(reader.ReadOuterXml());</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Note:</b> by default, the result is an XML fragment, and not a valid XML document. It is, effectively, a sequence of XML elements that represent each row in the results set. Therefore, at minimum, you must wrap the output with a single root element so that it is well-formed. See <a href="https://docs.microsoft.com/en-us/dotnet/api/system.xml.xmlreader?view=netframework-4.8">XmlReader</a> for more details.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Retrieving Single Scalar Values</h3>
<p>The Data Access block provides the <code>ExecuteScalar</code> method to extract a single scalar value based on a query that selects either a single row or a single value. It executes the query you specify, and then returns the value of the first column of the first row of the result set as an Object type.</p>
<p>The <code>ExecuteScalar</code> method has a set of overloads similar to the <code>ExecuteReader</code> method we used earlier in this document. You can specify a <code>CommandType</code> (the default is <code>StoredProcedure</code>) and either a SQL statement or a stored procedure name. You can also pass in an array of <code>Object</code> instances that represent the parameters for the query. Alternatively, you can pass to the method a <code>DbCommand</code> object that contains any parameters you require.</p>
<p>The following code demonstrates passing a <code>DbCommand</code> object to the method to execute both an inline SQL statement and a stored procedure. It obtains a suitable <code>DbCommand</code> instance from the current Database instance using the <code>GetSqlStringCommand</code> and <code>GetStoredProcCommand</code> methods. You can add parameters to the command before calling the <code>ExecuteScalar</code> method if required. However, to demonstrate the way the method works, the code here simply extracts the complete row set. The result is a single <code>Object</code> that you must cast to the appropriate type before displaying or consuming it in your code.</p>
<div class="fragment"><div class="line"><span class="comment">// Create a suitable command type for a SQL statement.</span></div>
<div class="line"><span class="comment">// NB: For efficiency, aim to return only a single value or a single row.</span></div>
<div class="line"><span class="keyword">using</span> (DbCommand sqlCmd = defaultDB.GetSqlStringCommand(<span class="stringliteral">&quot;SELECT [Name] FROM States&quot;</span>))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Call the ExecuteScalar method of the command.</span></div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;Result using a SQL statement: {0}&quot;</span>, defaultDB.ExecuteScalar(sqlCmd).ToString());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create a suitable command type for a stored procedure.</span></div>
<div class="line"><span class="comment">// NB: For efficiency, aim to return only a single value or a single row.</span></div>
<div class="line"><span class="keyword">using</span> (DbCommand sprocCmd = defaultDB.GetStoredProcCommand(<span class="stringliteral">&quot;GetStatesList&quot;</span>))</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Call the ExecuteScalar method of the command.</span></div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;Result using a stored procedure: {0}&quot;</span>, defaultDB.ExecuteScalar(sprocCmd).ToString());</div>
<div class="line">}</div>
</div><!-- fragment --><p> The result it produces is shown here. </p><div class="fragment"><div class="line">Result using a SQL statement: Alabama</div>
<div class="line">Result using a stored procedure: Alabama</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md12"></a>
Retrieving Data Asynchronously</h3>
<p>Databases are a major bottleneck in any enterprise application. One way that applications can minimize the performance hit from data access is to perform it asynchronously. This means that the application code can continue to execute, and the user interface can remain interactive during the process. It is also very useful in server applications where you can avoid blocking threads that could handle other requests, thus improving utilization. However, keep in mind that asynchronous data access has an effect on connection and data streaming performance over the wire. Don’t expect a query that returns ten rows to show any improvement using an asynchronous approach—it is more likely to take longer to return the results!</p>
<p>The Data Access block provides asynchronous <code>Begin</code> and <code>End</code> versions of many of the standard data access methods, including <code>ExecuteReader</code>, <code>ExecuteScalar</code>, <code>ExecuteXmlReader</code>, and <code>ExecuteNonQuery</code>. It also provides asynchronous <code>Begin</code> and <code>End</code> versions of the <code>Execute</code> method for accessors that return data as a sequence of objects. This approach is known as the Asynchronous Programming Model (APM). A future version of the block will also support the <a href="https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/task-parallel-library-tpl">Task Parallel Library</a> (TPL). In the mean time, you can use <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.taskfactory.fromasync">TaskFactory.FromAsync</a> to wrap a <code>Begin</code> and <code>End</code> method with a <code>Task</code>.</p>
<p>Asynchronous processing in the Data Access block is only available for SQL Server databases. The <code>Database</code> class includes a property named <code>SupportsAsync</code> that you can query to see if the current Database instance supports asynchronous operations. The example for this chapter contains a simple check for this.</p>
<p>The <code>BeginExecuteReader</code> method does not accept a <code>CommandBehavior</code> parameter. By default, the method will automatically set the <code>CommandBehavior</code> property on the underlying reader to <code>CloseConnection</code> unless you specify a transaction when you call the method. If you do specify a transaction, it does not set the <code>CommandBehavior</code> property.</p>
<p>Always ensure you call the appropriate <code>EndExecute</code> method when you use asynchronous data access, even if you do not actually require access to the results, or call the Cancel method on the connection. Failing to do so can cause memory leaks and consume additional system resources.</p>
<p>Using asynchronous data access with the Multiple Active Results Set (MARS) feature of ADO.NET may produce unexpected behavior, and should generally be avoided.</p>
<p>The following code creates a <code>DBCommand</code> instance and adds two parameters, and then calls the <code>BeginExecuteReader</code> method of the <code>Database</code> class to start the process. The code passes to this method a reference to the command to execute (with its parameters already added), a Lambda expression to execute when the data retrieval process completes, and a <b>null</b> value for the <code>AsyncState</code> parameter. The Lambda expression then calls the <code>EndExecuteReader</code> method to obtain the results of the query execution. At this point you can consume the row set in your application. Notice that the callback expression should handle any errors that may occur during the asynchronous operation.</p>
<div class="fragment"><div class="line"><span class="comment">// Create command to execute stored procedure and add parameters.</span></div>
<div class="line">DbCommand cmd = asyncDB.GetStoredProcCommand(<span class="stringliteral">&quot;ListOrdersSlowly&quot;</span>);</div>
<div class="line">asyncDB.AddInParameter(cmd, <span class="stringliteral">&quot;state&quot;</span>, DbType.String, <span class="stringliteral">&quot;Colorado&quot;</span>);</div>
<div class="line">asyncDB.AddInParameter(cmd, <span class="stringliteral">&quot;status&quot;</span>, DbType.String, <span class="stringliteral">&quot;DRAFT&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Execute the query asynchronously specifying the command and the expression to execute when the data access</span></div>
<div class="line"><span class="comment">// process completes.</span></div>
<div class="line">asyncDB.BeginExecuteReader(cmd,</div>
<div class="line">  asyncResult =&gt;</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// Lambda expression executed when the data access completes.</span></div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">      <span class="keyword">using</span> (IDataReader reader = asyncDB.EndExecuteReader(asyncResult))</div>
<div class="line">      {</div>
<div class="line">        DisplayRowValues(reader);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">catch</span> (Exception ex)</div>
<div class="line">    {</div>
<div class="line">      Console.WriteLine(<span class="stringliteral">&quot;Error after data access completed: {0}&quot;</span>, ex.Message);</div>
<div class="line">    }</div>
<div class="line">  }, <span class="keyword">null</span>);</div>
</div><!-- fragment --><p>The <code>AsyncState</code> parameter can be used to pass any required state information into the callback. For example, when you use a callback method instead of a lambda expression, you would pass a reference to the current <code>Database</code> instance as the <code>AsyncState</code> parameter so that the callback code can call the <code>EndExecuteReader</code> (or other appropriate End method) to obtain the results. When you use a Lambda expression, the current Database instance is available within the expression and, therefore, you do not need to populate the <code>AsyncState</code> parameter.</p>
<p>As mentioned above, you can wrap a BeginXXX and EndXXX methods with a Task. </p><div class="fragment"><div class="line">await Task&lt;IDataReader&gt;.Factory</div>
<div class="line">        .FromAsync&lt;DbCommand&gt;(asyncDB.BeginExecuteReader, </div>
<div class="line">        asyncDB.EndExecuteReader, cmd, <span class="keyword">null</span>);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md13"></a>
Updating Data</h3>
<p>The Data Access block makes it easy to execute inline SQL statements, or SQL statements within stored procedures, that use the <code>UPDATE</code>, <code>DELETE</code>, or <code>INSERT</code> keywords. queries against a database. You can execute these kinds of queries using the <code>ExecuteNonQuery</code> method of the <code>Database</code> class.</p>
<p>The <code>ExecuteNonQuery</code> method has a broad set of overloads. You can specify a <code>CommandType</code> (the default is <code>StoredProcedure</code>) and either a SQL statement or a stored procedure name. You can also pass in an array of Object instances that represent the parameters for the query. Alternatively, you can pass to the method a <code>DbCommand</code> object that contains any parameters you require. There are also <code>Begin</code> and <code>End</code> versions that allow you to execute update queries asynchronously. A future version will support a Task based asynchronous method.</p>
<p>The following code shows how you can use the <code>ExecuteNonQuery</code> method to update a row in a table in the database. It updates the Description column of a single row in the Products table, checks that the update succeeded, and then updates it again to return it to the original value. The first step is to create the command and add the required parameters, as you've seen in earlier examples, and then call the <code>ExecuteNonQuery</code> method with the command as the single parameter. Next, the code changes the value of the command parameter named <code>description</code> to the original value in the database, and then executes the compensating update.</p>
<div class="fragment"><div class="line"><span class="keywordtype">string</span> oldDescription = <span class="stringliteral">&quot;Carries 4 bikes securely; steel construction, fits 2\&quot; receiver hitch.&quot;</span>;</div>
<div class="line"><span class="keywordtype">string</span> newDescription = <span class="stringliteral">&quot;Bikes tend to fall off after a few miles.&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create command to execute the stored procedure and add the parameters.</span></div>
<div class="line">DbCommand cmd = defaultDB.GetStoredProcCommand(<span class="stringliteral">&quot;UpdateProductsTable&quot;</span>);</div>
<div class="line">defaultDB.AddInParameter(cmd, <span class="stringliteral">&quot;productID&quot;</span>, DbType.Int32, 84);</div>
<div class="line">defaultDB.AddInParameter(cmd, <span class="stringliteral">&quot;description&quot;</span>, DbType.String, newDescription);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Execute the query and check if one row was updated.</span></div>
<div class="line"><span class="keywordflow">if</span> (defaultDB.ExecuteNonQuery(cmd) == 1)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Update succeeded.</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;ERROR: Could not update just one row.&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Change the value of the second parameter</span></div>
<div class="line">defaultDB.SetParameterValue(cmd, <span class="stringliteral">&quot;description&quot;</span>, oldDescription);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Execute query and check if one row was updated</span></div>
<div class="line"><span class="keywordflow">if</span> (defaultDB.ExecuteNonQuery(cmd) == 1)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Update succeeded.</span></div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    Console.WriteLine(<span class="stringliteral">&quot;ERROR: Could not update just one row.&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <code>ExecuteNonQuery</code> method returns an integer value that is the number of rows updated (or, to use the more accurate term, affected) by the query. In this example, we are specifying a single row as the target for the update by selecting on the unique ID column. Therefore, we expect only one row to be updated—any other value means there was a problem. If you are expecting to update multiple rows, you would check for a non-zero returned value.</p>
<h3><a class="anchor" id="autotoc_md14"></a>
Working with DataSets</h3>
<h4><a class="anchor" id="autotoc_md15"></a>
Retrieving data as DataSet</h4>
<p>If you need to retrieve data and store it in a way that allows you to push changes back into the database, you will usually use a <code>DataSet</code>. The Data Access block supports simple operations on a normal (non-typed) <code>DataSet</code>, including the capability to fill a <code>DataSet</code> and then update the original database table from the <code>DataSet</code>.</p>
<p>To fill a <code>DataSet</code>, you use the <a class="el" href="a00440.html#afde29063cc35c6985d15957c512f4a76">ExecuteDataSet</a> method, which returns a new instance of the <code>DataSet</code> class populated with a table containing the data for each row set returned by the query (which may be a multiple-statement batch query). The tables in this <code>DataSet</code> will have default names such as Table, Table1, and Table2.</p>
<p>If you want to load data into an existing <code>DataSet</code>, you use the <code>LoadDataSet</code> method. This allows you to specify the name(s) of the target table(s) in the <code>DataSet</code>, and lets you add additional tables to an existing <code>DataSet</code> or refresh the contents of specific tables in the DataSet.</p>
<p>Both of these methods have a broad set of overloads. You can specify a <code>CommandType</code> (the default is <code>StoredProcedure</code>) and either a SQL statement or a stored procedure name. You can also pass the values that represent the input parameters for the query. Alternatively, you can pass to the method a <code>DbCommand</code> object that contains any parameters you require.</p>
<p>The following code example shows how you can use the <code>ExecuteDataSet</code> method with a SQL statement; with a stored procedure and a parameter array; and with a command pre-populated with parameters. The code assumes you have created the Data Access block <code>Database</code> instance named <code>db</code>.</p>
<div class="fragment"><div class="line">DataSet productDataSet;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Using a SQL statement.</span></div>
<div class="line"><span class="keywordtype">string</span> sql = <span class="stringliteral">&quot;SELECT CustomerName, CustomerPhone FROM Customers&quot;</span>;</div>
<div class="line">productDataSet = db.ExecuteDataSet(CommandType.Text, sql);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Using a stored procedure and a parameter array.</span></div>
<div class="line">productDataSet = db.ExecuteDataSet(<span class="stringliteral">&quot;GetProductsByCategory&quot;</span>, <span class="stringliteral">&quot;%bike%&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Using a stored procedure and a named parameter.</span></div>
<div class="line">DbCommand cmd = db.GetStoredProcCommand(<span class="stringliteral">&quot;GetProductsByCategory&quot;</span>);</div>
<div class="line">db.AddInParameter(cmd, <span class="stringliteral">&quot;CategoryID&quot;</span>, DbType.Int32, 7);</div>
<div class="line">productDataSet = db.ExecuteDataSet(cmd);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md16"></a>
Updating the Database from a DataSet</h4>
<p>To update data in a database from a <code>DataSet</code>, you use the <a class="el" href="a00440.html#a32d38d4f1d2d5f13566d2ed19a6d28a2">UpdateDataSet</a> method, which returns a total count of the number of rows affected by the update, delete, and insert operations. The overloads of this method allow you to specify the source <code>DataSet</code> containing the updated rows, the name of the table in the database to update, and references to the three <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.common.dbcommand">DbCommand</a> instances that the method will execute to perform UPDATE, DELETE, and INSERT operations on the specified database table.</p>
<p>In addition, you can specify a value for the <a class="el" href="a00245.html#ae5a4ed3e9684a7321ace50e03543a92a">UpdateBehavior</a>, which determines how the method will apply the updates to the target table rows. You can specify one of the following values for this parameter:</p>
<ul>
<li><b>Standard</b>. If the underlying ADO.NET update process encounters an error, the update stops and no subsequent updates are applied to the target table.</li>
<li><b>Continue</b>. If the underlying ADO.NET update process encounters an error, the update will continue and attempt to apply any subsequent updates.</li>
<li><b>Transactional</b>. If the underlying ADO.NET update process encounters an error, all the updates made to all rows will be rolled back.</li>
</ul>
<p>Finally, you can optionally provide a value for the <code>updateBatchSize</code> parameter of the <code>UpdateDataSet</code> method. This forces the method to attempt to perform updates in batches instead of sending each one to the database individually. This is more efficient, but the return value for the method will show only the number of updates made in the final batch, and not the total number for all batches. Typically, you are likely to use a batch size value between 10 and 100. You should experiment to find the most appropriate batch size; it depends on the type of database you are using, the query you are executing, and the number of parameters for the query.</p>
<p>The following examples demonstrates the <code>ExecuteDataSet</code> and <code>UpdateDataSet</code> methods. It uses the simple overloads of the <code>ExecuteDataSet</code> and <code>LoadDataSet</code> methods to fill two <code>DataSet</code> instances, using a separate routine named <code>DisplayTableNames</code> (not shown here) to display the table names and a count of the number of rows in these tables. This shows one of the differences between these two methods. Note that the <code>LoadDataSet</code> method requires a reference to an existing <code>DataSet</code> instance, and an array containing the names of the tables to populate.</p>
<div class="fragment"><div class="line"><span class="keywordtype">string</span> selectSQL = <span class="stringliteral">&quot;SELECT Id, Name, Description FROM Products WHERE Id &gt; 90&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Fill a DataSet from the Products table using the simple approach.</span></div>
<div class="line">DataSet simpleDS = defaultDB.ExecuteDataSet(CommandType.Text, selectSQL);</div>
<div class="line">DisplayTableNames(simpleDS, <span class="stringliteral">&quot;ExecuteDataSet&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Fill a DataSet from the Products table using the LoadDataSet method.</span></div>
<div class="line"><span class="comment">// This allows you to specify the name(s) for the table(s) in the DataSet.</span></div>
<div class="line">DataSet loadedDS = <span class="keyword">new</span> DataSet(<span class="stringliteral">&quot;ProductsDataSet&quot;</span>);</div>
<div class="line">defaultDB.LoadDataSet(CommandType.Text, selectSQL, loadedDS, <span class="keyword">new</span> <span class="keywordtype">string</span>[] { <span class="stringliteral">&quot;Products&quot;</span> });</div>
<div class="line">DisplayTableNames(loadedDS, <span class="stringliteral">&quot;LoadDataSet&quot;</span>);</div>
</div><!-- fragment --><p> This produces the following result: </p><div class="fragment"><div class="line">Tables in the DataSet obtained using the ExecuteDataSet method:</div>
<div class="line"> - Table named &#39;Table&#39; contains 6 rows.</div>
<div class="line"> </div>
<div class="line">Tables in the DataSet obtained using the LoadDataSet method:</div>
<div class="line"> - Table named &#39;Products&#39; contains 6 rows.</div>
</div><!-- fragment --><p>Let's say you updated, added and deleted some row in the Products table. The next stage is to create the commands that the <code>UpdateDataSet</code> method will use to update the target table in the database. The code declares three suitable SQL statements, and then builds the commands and adds the requisite parameters to them. Note that each parameter may be applied to multiple rows in the target table, so the actual value must be dynamically set based on the contents of the DataSet row whose updates are currently being applied to the target table.</p>
<p>This means that you must specify, in addition to the parameter name and data type, the name and the version (Current or Original) of the row in the DataSet to take the value from. For an INSERT command, you need the current version of the row that contains the new values. For a DELETE command, you need the original value of the ID to locate the row in the table that will be deleted. For an UPDATE command, you need the original value of the ID to locate the row in the table that will be updated, and the current version of the values with which to update the remaining columns in the target table row.</p>
<div class="fragment"><div class="line"><span class="keywordtype">string</span> addSQL = <span class="stringliteral">&quot;INSERT INTO Products (Name, Description) VALUES (@name, @description)&quot;</span>;</div>
<div class="line"><span class="keywordtype">string</span> updateSQL = <span class="stringliteral">&quot;UPDATE Products SET Name = @name, Description = @description WHERE Id = @id&quot;</span>;</div>
<div class="line"><span class="keywordtype">string</span> deleteSQL = <span class="stringliteral">&quot;DELETE FROM Products WHERE Id = @id&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create the commands to update the original table in the database</span></div>
<div class="line">DbCommand insertCommand = defaultDB.GetSqlStringCommand(addSQL);</div>
<div class="line">defaultDB.AddInParameter(insertCommand, <span class="stringliteral">&quot;name&quot;</span>, DbType.String, <span class="stringliteral">&quot;Name&quot;</span>, DataRowVersion.Current);</div>
<div class="line">defaultDB.AddInParameter(insertCommand, <span class="stringliteral">&quot;description&quot;</span>, DbType.String, <span class="stringliteral">&quot;Description&quot;</span>, DataRowVersion.Current);</div>
<div class="line"> </div>
<div class="line">DbCommand updateCommand = defaultDB.GetSqlStringCommand(updateSQL);</div>
<div class="line">defaultDB.AddInParameter(updateCommand, <span class="stringliteral">&quot;name&quot;</span>, DbType.String, <span class="stringliteral">&quot;Name&quot;</span>, DataRowVersion.Current);</div>
<div class="line">defaultDB.AddInParameter(updateCommand, <span class="stringliteral">&quot;description&quot;</span>, DbType.String, <span class="stringliteral">&quot;Description&quot;</span>, DataRowVersion.Current);</div>
<div class="line">defaultDB.AddInParameter(updateCommand, <span class="stringliteral">&quot;id&quot;</span>, DbType.String, <span class="stringliteral">&quot;Id&quot;</span>, DataRowVersion.Original);</div>
<div class="line"> </div>
<div class="line">DbCommand deleteCommand = defaultDB.GetSqlStringCommand(deleteSQL);</div>
<div class="line">defaultDB.AddInParameter(deleteCommand, <span class="stringliteral">&quot;id&quot;</span>, DbType.Int32, <span class="stringliteral">&quot;Id&quot;</span>, DataRowVersion.Original);</div>
</div><!-- fragment --><p>Finally, you can apply the changes by calling the UpdateDataSet method, as shown here:</p>
<div class="fragment"><div class="line"><span class="comment">// Apply the updates in the DataSet to the original table in the database.</span></div>
<div class="line"><span class="keywordtype">int</span> rowsAffected = defaultDB.UpdateDataSet(loadedDS, <span class="stringliteral">&quot;Products&quot;</span>, insertCommand, updateCommand, deleteCommand, <a class="code" href="a00245.html#ae5a4ed3e9684a7321ace50e03543a92a">UpdateBehavior</a>.Standard);</div>
<div class="line">Console.WriteLine(<span class="stringliteral">&quot;Updated a total of {0} rows in the database.&quot;</span>, rowsAffected);</div>
<div class="ttc" id="aa00245_html_ae5a4ed3e9684a7321ace50e03543a92a"><div class="ttname"><a href="a00245.html#ae5a4ed3e9684a7321ace50e03543a92a">Microsoft.Practices.EnterpriseLibrary.Data.UpdateBehavior</a></div><div class="ttdeci">UpdateBehavior</div><div class="ttdoc">Used with the Database.UpdateDataSet method. Provides control over behavior when the Data Adapter's u...</div><div class="ttdef"><b>Definition:</b> UpdateBehavior.cs:10</div></div>
</div><!-- fragment --><p> The code captures and displays the number of rows affected by the updates. As expected, this is three, as shown in the final section of the output from the example.</p>
<div class="fragment"><div class="line">Updated a total of 3 rows in the database.</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
